name: Build and Install OpenSSL

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential checkinstall zlib1g-dev

    - name: Download OpenSSL
      run: |
        wget https://www.openssl.org/source/openssl-3.0.13.tar.gz
        tar -xzvf openssl-3.0.13.tar.gz
        

    - name: Configure and build OpenSSL
      run: |
        cd openssl-3.0.13
        ./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl
        make
        sudo make install

    - name: Update shared libraries
      run: |
        sudo ldconfig

    - name: Verify OpenSSL installation
      run: |
        /usr/local/openssl/bin/openssl version

    - name: Setup OpenSSL configuration
      run: |
        sudo cp /usr/local/openssl/ssl/openssl.cnf /etc/ssl/
        sudo cp /usr/local/openssl/lib/engines-3/*.so /usr/lib/x86_64-linux-gnu/engines-3/

    - name: Setup OpenSSL daemon
      run: |
        sudo cp /usr/local/openssl/bin/openssl /usr/sbin/
        sudo systemctl daemon-reload
        sudo systemctl enable openssl
        sudo systemctl start openssl
